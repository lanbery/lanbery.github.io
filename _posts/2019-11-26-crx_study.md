---
layout:     post
title:      Browser Extension
subtitle:   crx 
date:       2019-11-26
author:     lanbery
header-img: docs/images/2019/network_bg.png
catalog: true
tags:
    - Browser
    - nodejs  
---
> Getting Started
> 
> Mind Mapping

<a href="https://developer.chrome.com/extensions/messaging" target="Chrome Messing">CRX Message</a>



## Knowledge 
  - PPAPI (替代chrome-v42 之前的C++动态库调用方案)
  - 网络请求控制
  - 事件监听
  - 通信机制
  - https 认证机制
  
> Chrome Extension 优势,除应用在chrome 上外,还可以运行所有webkit内核的浏览器.

<a href="https://www.cnblogs.com/liuxianan/p/chrome-plugin-develop.html" target="CRX Guide">CRX Blog</a>

## Develop & Debug
    chrome extension 文件夹下需要有manifest.json 文件
    勾选开发模式,即可直接加载插件,不必打包成*.crx格式 
    

### manifest.json 核心文件
```json
{
    //清单版本
    "manifest_version":2,
    "name":"basex",
    "version":"1.0.0",
    "description":"Bas Chrome Extendsion",
    "icons":{
        "16":"img/icon.png",
        "48":"",
        "128":""
    },
    //always run process js or background page
    "background":{
        "page":"background.html",
        //"scripts":["js/background.js"]
    },
    //浏览器右上角图标设置,browser_action/page_action/app必须三选一
    "browser_action":{
        "default_icon":"img/icon.png",
        //悬停时的标题,可选.[bas设计:]
        "default_title":"Blockchain Address Service Extendsion",
        //显示余额,wallet simple,query
        "default_popup":"popu.html"
    },
    //当一些特定页面打开才显示的图标
    /**
    "page_action":{
        "default_icon":"img/icon.png",
        ...
    },
    */
    //需要直接注入页面的JS
    "content_scripts":[
        {
            //"matches":["http://*/*","https://*/*"]
            //"<all_urls>" 标识匹配所有地址
            "matches":["<all_urls>"],
            //插入匹配页面的JS
            "js":["js/jqury","js/content-script.js"],
            //css
            "css":["css/sss.css"],
            //代码注入的时间,可选值:"document_start","document_end" or "document_idle" 代表页面空闲时,默认document_idle
            "run_at":"document_idle"
        },
        {
            ....
        }
    ],
    //权限申请
    "permissions":[
        "contextMenus",//右键菜单
        "tab",//标签
        "notifications",//通知
        "webRequest",//web请求
        "webRequestBlocking",
        "storage",//本地存储
        "http://*/*",//可以通过executeScript或insertCss访问的网站
    ],
    //普通页面能够直接访问的插件资源列表,如不设置是无法直接访问的.
    "web_accessible_resources":["js/inject.js"],
    //插件主页
    "homepage_url":"https://www.home.bas",
    ...
    "options_page":"options.html",//chrome 40 之前配置
    //chrome 40 之后用,两个都写,新版本只认第二个
    "options_ui":{
        "page":"options.html",
        "chrome_style":true
    },
    //向地址栏注册一个关键字已提供搜索建议,只能设置一个关键字 ??
    "omnibox":{"keyword":"bas"},
    "default_locale":"zh_CN",
    ...
}    
```

> background 常驻后台的页面,生命周期随着浏览器打开而打开,浏览器关闭而关闭
> event-pages 鉴于background生命周期太长,会影响性能,才有event-pages,

```js
{
    "background":{
        "scripts":["event-page.js"],
        "persistent":false//
    }
}
```


## solutions 
利用webRequest 拦截bas://xxx协议,阻塞请求 =>
到合约查询ip地址或BCAddress 直接返回 http 或 https


## Extension folder path
```bash
chrome://version

```
https://github.com/ahwayakchih/crx3

https://judge.sh/how-to-enable-dns-over-https-on-chrome-right-now/


google.com dns:59.24.3.174
---

# Firefox

## WexExtension 

> Signed Extension 

<a href="https://addons.mozilla.org/zh-CN/developers/" target="firefoxSigned">Signed</a>

> This library allows extensions that use the Promise-based WebExtension/BrowserExt API being standardized by the W3 Browser Extensions group to run on Google Chrome with minimal or no changes.

https://github.com/mdn/webextensions-examples

https://extensionworkshop.com/documentation/develop/getting-started-with-web-ext/


## WebExtension API 

> request API 

```bash
Additional objects
details
documentUrl
string. URL of the document in which the resource will be loaded. For example, if the web page at "https://example.com" contains an image or an iframe, then the documentUrl for the image or iframe will be "https://example.com". For a top-level document, documentUrl is undefined.
frameId
integer. Zero if the request happens in the main frame; a positive value is the ID of a subframe in which the request happens. If the document of a (sub-)frame is loaded (type is main_frame or sub_frame), frameId indicates the ID of this frame, not the ID of the outer frame. Frame IDs are unique within a tab.
method
string. Standard HTTP method: for example, "GET" or "POST".
originUrl
string. URL of the resource which triggered the request. For example, if "https://example.com" contains a link, and the user clicks the link, then the originUrl for the resulting request is "https://example.com".

The originUrl is often but not always the same as the documentUrl. For example, if a page contains an iframe, and the iframe contains a link that loads a new document into the iframe, then the documentUrl for the resulting request will be the iframe's parent document, but the originUrl will be the URL of the document in the iframe that contained the link.

parentFrameId
integer. ID of the frame that contains the frame which sent the request. Set to -1 if no parent frame exists.
proxyInfo
object. This property is present only if the request is being proxied. It contains the following properties:

host
string. The hostname of the proxy server.
port
integer. The port number of the proxy server.
type
string. The type of proxy server. One of:

"http": HTTP proxy (or SSL CONNECT for HTTPS)
"https": HTTP proxying over TLS connection to proxy
"socks": SOCKS v5 proxy
"socks4": SOCKS v4 proxy
"direct": no proxy
"unknown": unknown proxy
username
string. Username for the proxy service.
proxyDNS
boolean. True if the proxy will perform domain name resolution based on the hostname supplied, meaning that the client should not do its own DNS lookup.
failoverTimeout
integer. Failover timeout in seconds. If the proxy connection fails, the proxy will not be used again for this period.
requestHeadersOptional
webRequest.HttpHeaders. The HTTP request headers that will be sent with this request.
requestId
string. The ID of the request. Request IDs are unique within a browser session, so you can use them to relate different events associated with the same request.
tabId
integer. ID of the tab in which the request takes place. Set to -1 if the request isn't related to a tab.
timeStamp
number. The time when this event fired, in milliseconds since the epoch.
type
webRequest.ResourceType. The type of resource being requested: for example, "image", "script", "stylesheet".
url
string. Target of the request.
```