---
layout:     post
title:      SSL/TSL 证书
subtitle:   
date:       2019-05-22
author:     lanbery
header-img: img/post-bg-hacker.jpg
catalog: true
tags:
    - Linux
    - Web	
---

> 免费 https 证书

> 参考原贴：https://keelii.com/2016/06/12/free-https-cert-lets-encrypt-apply-install/ [如侵权，请联系删除]

# 免費申請證書
通過certbot申請，只需要四步，就完成SSL證書申請使用。

  - 下載 certbot
  - 生成免費證書
  - 生成dhparams
  - 配置Nginx

## Certbot 項目

  git clone https://github.com/certbot/certbot.git

  cd certbot
  ./certbot-auto --help

## 生成

<code shell>
./certbot-auto certonly --webroot --agree-tos -v -t --email <your@mail.com> -w <your site path[/usr/share/nginx/html]> -d <your Domain[cnm.cn]>
</code>  

如果返回正常就确认了你对这个网站的所有权，就能顺利生成，完成后这个目录会被清空  .
生成的證書默認存放在 /etc/letsencrypt/live/下

## 生成dhparams

使用 openssl 工具生成 dhparams

openssl dhparam用于生成和管理dh文件,dh(Diffie-Hellman)是著名的密钥交换协议，或称为密钥协商协议，它可以保证通信双方安全地交换密钥。但注意，它不是加密算法，所以不提供加密功能，仅仅只是保护密钥交换的过程.

openssl dhparam [-in filename] [-out filename] [-dsaparam] [-noout] [-text] [-rand file(s)] [numbits]

选项说明：


  - [-in filename]：从filename文件中读取密钥交换协议参数。
  - [-out filename]：输出密钥交换协议参数到filename文件。
  - [-dsaparam]：指定此选项将使用dsa交换协议替代dh交换协议。虽然生成速度更快，但更不安全。
  - [-noout]：禁止输出任何信息。
  - [-text]：以文本格式输出dh协议。
  - [-rand]：指定随机数种子文件。
  - [-numbits]：指定生成的长度


<code shell>
  openssl dhparam -out /etc/ssl/serts/dhparams.pem 2048
</code>	

## 配置Nginx

  * [参考Nginx](https://lanbery.github.io/2019/07/02/Centos74-Nginx/)

<code json>

  server {

    listen  80;
    server_name ppn.one;
    return 301  https://$server_name$request_uri;

  }

  server {

    listen  443 ssl;
    server_name   ppn.one;
    root      /data/www/ppn;
    add_header  Strict-Transport-Security "max-age=31536000";
  
    #ssl      on;
    ssl_certificate /etc/letsencrypt/live/www.ppn.one/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.ppn.one/privkey.pem;
    ssl_dhparam   /etc/ssl/certs/dhparams.ppn.pem;
    ssl_protocols   SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers   ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;

    location / {

    }

  }

</code>   

## 定时更新
> 每天检查 renew

0 0 * * * root /data/www/renew.cert.sh

<code shell>
#!/bin/bash

DAYSDIFF=$((($(date +%s) - $(date +%s -d '20190811'))/86400))
DIFFMOD=$(($DAYSDIFF % 90))

if [ $DIFFMOD = 1 ];then
  echo -e ">> exec renew certbot \n" >> /data/www/logs/renew.log
  /root/work/certbot/certbot-auto renew >> /data/www/logs/renew.log
else
  echo -e "did't need renew. \n" >> /data/www/logs/renew.log
fi

</code>
